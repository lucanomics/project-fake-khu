<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F.A.K.E ID</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/qrcode@1.5.3/build/qrcode.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <link rel="manifest" href='data:application/manifest+json,{"name":"F.A.K.E ID Card","short_name":"F.A.K.E ID","description":"경희대학교 F.A.K.E 프로젝트 공식 디지털 명함","start_url":"/id-card.html","display":"standalone","background_color":"#0f172a","theme_color":"#4c6ef5","icons":[{"src":"https://lucanomics.github.io/project-fake-khu/fakhu_logo.png","sizes":"192x192","type":"image/png"},{"src":"https://lucanomics.github.io/project-fake-khu/fakhu_logo.png","sizes":"512x512","type":"image/png"}]}'>
    <meta name="theme-color" content="#0f172a">

    <style>
        body { 
            background-color: #0f172a; 
            color: white; 
            font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, sans-serif;
            -webkit-font-smoothing: antialiased;
            touch-action: manipulation;
        }
        .glass-panel { 
            background: rgba(15, 23, 42, 0.7); 
            backdrop-filter: blur(16px); 
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08); 
        }
        #cardCanvas { display: none; }
        .card-container { perspective: 1000px; cursor: pointer; }
        .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; }
        .card-container.flipped .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; border-radius: 1.5rem; overflow: hidden; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); }
        .card-back { transform: rotateY(180deg); background-color: #fff; }
        select option { background-color: #1e293b; color: white; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #ffffff; cursor: pointer; margin-top: -6px; box-shadow: 0 0 2px rgba(0,0,0,0.5); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #475569; border-radius: 2px; }
        
        @keyframes modalFadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-content { animation: modalFadeIn 0.2s ease-out; }
        .animate-fade-in { animation: modalFadeIn 0.3s ease-out forwards; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // --- 1. 학과 데이터 ---
        const departmentData = {
            "Hospitality경영학과": { code: "101", eng: "Dept. of Hospitality Management" },
            "간호학과": { code: "102", eng: "Dept. of Nursing" },
            "건축공학과": { code: "203", eng: "Dept. of Architectural Engineering" },
            "건축학과": { code: "204", eng: "Dept. of Architecture (5-year)" },
            "경영학과": { code: "105", eng: "Dept. of Business Administration" },
            "경제학과": { code: "106", eng: "Dept. of Economics" },
            "골프산업학과": { code: "207", eng: "Dept. of Golf Industry" },
            "관광학과": { code: "108", eng: "Dept. of Tourism Studies" },
            "국어국문학과": { code: "109", eng: "Dept. of Korean Language & Literature" },
            "국제통상·금융투자학부": { code: "110", eng: "Div. of Int'l Trade & Financial Inv." },
            "국제통상학과": { code: "110", eng: "Div. of Int'l Trade & Financial Inv." },
            "금융투자학과": { code: "110", eng: "Div. of Int'l Trade & Financial Inv." },
            "국제학과": { code: "211", eng: "Dept. of International Studies" },
            "글로벌커뮤니케이션학부": { code: "212", eng: "Div. of Global Communication" },
            "기계공학과": { code: "213", eng: "Dept. of Mechanical Engineering" },
            "기악과": { code: "114", eng: "Dept. of Instrumental Music" },
            "도예학과": { code: "215", eng: "Dept. of Ceramic Arts" },
            "디지털콘텐츠학과": { code: "216", eng: "Dept. of Digital Contents" },
            "러시아어학과": { code: "217", eng: "Dept. of Russian Language" },
            "무역학과": { code: "118", eng: "Dept. of International Trade" },
            "무용학부": { code: "119", eng: "Dept. of Dance" },
            "문화엔터테인먼트학과": { code: "120", eng: "Dept. of Culture & Entertainment" },
            "물리학과": { code: "121", eng: "Dept. of Physics" },
            "미디어학과": { code: "122", eng: "Dept. of Media Studies" },
            "미래정보디스플레이학부": { code: "123", eng: "Div. of Future Information Display" },
            "정보디스플레이학과": { code: "123", eng: "Div. of Future Information Display" },
            "빅데이터응용학과": { code: "124", eng: "Dept. of Applied Big Data" },
            "사학과": { code: "125", eng: "Dept. of History" },
            "사회기반시스템공학과": { code: "226", eng: "Dept. of Social Infrastructure Systems" },
            "사회학과": { code: "127", eng: "Dept. of Sociology" },
            "산업경영공학과": { code: "228", eng: "Dept. of Industrial & Management Eng." },
            "산업디자인학과": { code: "229", eng: "Dept. of Industrial Design" },
            "생물학과": { code: "130", eng: "Dept. of Biology" },
            "생체의공학과": { code: "231", eng: "Dept. of Biomedical Engineering" },
            "성악과": { code: "132", eng: "Dept. of Vocal Music" },
            "소프트웨어융합학과": { code: "233", eng: "Dept. of Software Convergence" },
            "수학과": { code: "134", eng: "Dept. of Mathematics" },
            "스마트팜과학과": { code: "235", eng: "Dept. of Smart Farm Science" },
            "스페인어학과": { code: "236", eng: "Dept. of Spanish Language" },
            "스포츠의학과": { code: "237", eng: "Dept. of Sports Medicine" },
            "스포츠지도학과": { code: "238", eng: "Dept. of Sports Coaching" },
            "시각디자인학과": { code: "239", eng: "Dept. of Visual Design" },
            "식품생명공학과": { code: "240", eng: "Dept. of Food Science & Biotechnology" },
            "식품영양학과": { code: "141", eng: "Dept. of Food and Nutrition" },
            "신소재공학과": { code: "242", eng: "Dept. of Materials Science & Eng." },
            "정보전자신소재공학과": { code: "242", eng: "Dept. of Materials Science & Eng." },
            "아동가족학과": { code: "143", eng: "Dept. of Child & Family Studies" },
            "아시아학과": { code: "244", eng: "Dept. of Asian Studies" },
            "글로벌한국학과": { code: "244", eng: "Dept. of Asian Studies" },
            "약학과": { code: "145", eng: "Dept. of Pharmacy" },
            "연극영화학과": { code: "246", eng: "Dept. of Theatre and Film" },
            "영어영문학과": { code: "147", eng: "Dept. of English Language & Literature" },
            "우주과학과": { code: "248", eng: "Dept. of Space Science" },
            "원자력공학과": { code: "249", eng: "Dept. of Nuclear Engineering" },
            "유전생명공학과": { code: "250", eng: "Dept. of Genetic Engineering" },
            "융합바이오·신소재공학과": { code: "251", eng: "Dept. of Convergence Bio & Advanced Materials" },
            "한방생명공학과": { code: "251", eng: "Dept. of Convergence Bio & Advanced Materials" },
            "식물·환경신소재공학과": { code: "251", eng: "Dept. of Convergence Bio & Advanced Materials" },
            "응용물리학과": { code: "252", eng: "Dept. of Applied Physics" },
            "응용수학과": { code: "253", eng: "Dept. of Applied Mathematics" },
            "응용영어통번역학과": { code: "154", eng: "Dept. of Applied English Interpretation" },
            "응용화학과": { code: "255", eng: "Dept. of Applied Chemistry" },
            "의류디자인학과": { code: "256", eng: "Dept. of Fashion Design" },
            "의상학과": { code: "157", eng: "Dept. of Clothing and Textiles" },
            "의예과": { code: "158", eng: "Premedical Course (Medicine)" },
            "인공지능학과": { code: "259", eng: "Dept. of Artificial Intelligence" },
            "일본어학과": { code: "260", eng: "Dept. of Japanese Language" },
            "자유전공학부": { code: "261", eng: "Div. of Free Major Studies" },
            "자율전공학부": { code: "162", eng: "Div. of Interdisciplinary Studies" },
            "작곡과": { code: "163", eng: "Dept. of Composition" },
            "전자공학과": { code: "264", eng: "Dept. of Electronic Engineering" },
            "정치외교학과": { code: "165", eng: "Dept. of Political Science & IR" },
            "조리&푸드디자인학과": { code: "166", eng: "Dept. of Culinary & Food Design" },
            "조리·서비스경영학과": { code: "166", eng: "Dept. of Culinary & Food Design" },
            "조소과": { code: "167", eng: "Dept. of Sculpture" },
            "주거환경학과": { code: "168", eng: "Dept. of Housing & Env. Design" },
            "중국어학과": { code: "269", eng: "Dept. of Chinese Language" },
            "지리학과": { code: "170", eng: "Dept. of Geography" },
            "철학과": { code: "171", eng: "Dept. of Philosophy" },
            "체육학과": { code: "272", eng: "Dept. of Physical Education" },
            "치의예과": { code: "173", eng: "Predental Course (Dentistry)" },
            "컴퓨터공학과": { code: "274", eng: "Dept. of Computer Engineering" },
            "태권도학과": { code: "275", eng: "Dept. of Taekwondo" },
            "포스트모던음악학과": { code: "276", eng: "Dept. of Postmodern Music" },
            "프랑스어학과": { code: "277", eng: "Dept. of French Language" },
            "한국어학과": { code: "278", eng: "Dept. of Korean Language" },
            "한국화과": { code: "179", eng: "Dept. of Korean Painting" },
            "한약학과": { code: "180", eng: "Dept. of Herbal Pharmacology" },
            "한의예과": { code: "181", eng: "Pre-Korean Medicine Course" },
            "행정학과": { code: "182", eng: "Dept. of Public Administration" },
            "화학공학과": { code: "283", eng: "Dept. of Chemical Engineering" },
            "화학과": { code: "184", eng: "Dept. of Chemistry" },
            "환경조경디자인학과": { code: "285", eng: "Dept. of Env. Landscape Design" },
            "환경학및환경공학과": { code: "286", eng: "Dept. of Env. Science & Eng." },
            "회계세무학과": { code: "187", eng: "Dept. of Accounting and Taxation" },
            "회화과": { code: "188", eng: "Dept. of Painting" },
            "Florida State University": { code: "850", eng: "Florida State University" }
        };

        // --- 2. 아이콘 컴포넌트 ---
        const IconWrapper = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Download = (props) => (<IconWrapper {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconWrapper>);
        const Trash2 = (props) => (<IconWrapper {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconWrapper>);
        const RefreshCw = (props) => (<IconWrapper {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconWrapper>);
        const X = (props) => (<IconWrapper {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconWrapper>);
        const ImageIcon = (props) => (<IconWrapper {...props}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></IconWrapper>);
        const UploadCloud = (props) => (<IconWrapper {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></IconWrapper>);

        // --- 3. 카드 컴포넌트 ---
        const FlipCard = ({ card, onDelete, onClick }) => {
            const [isFlipped, setIsFlipped] = useState(false);

            const handleDownload = (e, side) => {
                e.stopPropagation();
                const link = document.createElement('a');
                link.href = side === 'front' ? card.image : card.backImage;
                link.download = `fake_id_${side}_${card.id}.png`;
                link.click();
            };

            const handleDelete = (e) => {
                e.stopPropagation();
                onDelete(card.id);
            };

            const handleClick = () => {
                if (onClick) onClick();
                else setIsFlipped(!isFlipped);
            };

            return (
                <div className="space-y-2">
                    <div className={`card-container aspect-[2/3] w-full ${isFlipped ? 'flipped' : ''}`} onClick={handleClick}>
                        <div className="card-inner">
                            <div className="card-front">
                                <img src={card.image} className="w-full h-full object-cover" alt="Front" />
                                <div className="absolute top-3 right-3 bg-black/30 p-1.5 rounded-full pointer-events-none backdrop-blur-sm">
                                    <RefreshCw size={16} className="text-white/80" />
                                </div>
                            </div>
                            <div className="card-back flex items-center justify-center bg-white">
                                <img src={card.backImage} className="w-full h-full object-cover" alt="Back" />
                            </div>
                        </div>
                    </div>
                    <div className="flex justify-between items-center bg-slate-800 p-2 rounded-xl text-xs shadow-lg">
                        <div className="flex gap-3 px-2">
                            <button onClick={(e) => handleDownload(e, 'front')} className="text-slate-300 hover:text-white flex items-center gap-1 font-semibold transition-colors">
                                Front <Download size={14}/>
                            </button>
                            <span className="text-slate-600">|</span>
                            <button onClick={(e) => handleDownload(e, 'back')} className="text-slate-300 hover:text-white flex items-center gap-1 font-semibold transition-colors">
                                Back <Download size={14}/>
                            </button>
                        </div>
                        <button onClick={handleDelete} className="p-1.5 bg-red-500/10 text-red-400 rounded-lg hover:bg-red-500 hover:text-white transition-all">
                            <Trash2 size={16}/>
                        </button>
                    </div>
                </div>
            );
        };

        const CardModal = ({ card, onClose, onDelete }) => {
            const [isFlipped, setIsFlipped] = useState(false);

            useEffect(() => {
                const handleEsc = (e) => { if (e.key === 'Escape') onClose(); };
                window.addEventListener('keydown', handleEsc);
                return () => window.removeEventListener('keydown', handleEsc);
            }, [onClose]);

            if (!card) return null;

            const handleDownload = (e, side) => {
                e.stopPropagation();
                const link = document.createElement('a');
                link.href = side === 'front' ? card.image : card.backImage;
                link.download = `fake_id_${side}_${card.id}.png`;
                link.click();
            };

            return (
                <div className="fixed inset-0 z-[5000] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md animate-fade-in" onClick={onClose}>
                    <div className="relative w-full max-w-sm modal-content" onClick={e => e.stopPropagation()}>
                        <button onClick={onClose} className="absolute -top-12 right-0 text-white hover:text-gray-300 transition-colors bg-white/10 p-2 rounded-full">
                            <X size={24} />
                        </button>

                        <div className={`card-container aspect-[2/3] w-full mb-6 ${isFlipped ? 'flipped' : ''}`} onClick={() => setIsFlipped(!isFlipped)}>
                            <div className="card-inner">
                                <div className="card-front">
                                    <img src={card.image} className="w-full h-full object-cover rounded-2xl shadow-2xl" alt="Front" />
                                </div>
                                <div className="card-back">
                                    <img src={card.backImage} className="w-full h-full object-cover rounded-2xl shadow-2xl" alt="Back" />
                                </div>
                            </div>
                        </div>

                        <div className="flex justify-between items-center bg-slate-800 p-4 rounded-2xl shadow-xl border border-slate-700">
                             <div className="flex gap-4">
                                <button onClick={(e) => handleDownload(e, 'front')} className="flex items-center gap-2 text-white font-bold bg-slate-700 px-4 py-3 rounded-xl hover:bg-slate-600 transition">
                                    Front <Download size={18}/>
                                </button>
                                <button onClick={(e) => handleDownload(e, 'back')} className="flex items-center gap-2 text-white font-bold bg-slate-700 px-4 py-3 rounded-xl hover:bg-slate-600 transition">
                                    Back <Download size={18}/>
                                </button>
                            </div>
                            <button onClick={() => { if(confirm('Delete this card?')) { onDelete(card.id); onClose(); } }} 
                                className="p-3 bg-red-500/20 text-red-400 rounded-xl hover:bg-red-500 hover:text-white transition">
                                <Trash2 size={20}/>
                            </button>
                        </div>
                        <p className="text-center text-slate-400 mt-6 text-sm font-medium animate-pulse">Tap card to flip • Tap background to close</p>
                    </div>
                </div>
            );
        };

        // --- 4. 메인 App 컴포넌트 ---
        const App = () => {
            const [view, setView] = useState('auth'); 
            const [password, setPassword] = useState('');
            const [authError, setAuthError] = useState('');
            
            const [rawImage, setRawImage] = useState(null);
            const [frontLogo, setFrontLogo] = useState('./fakhu_logo.png'); 
            
            const [frontImage, setFrontImage] = useState(null); 
            const [metaData, setMetaData] = useState({ name: '', role: 'Trainee', affiliation: '' });
            const [serialData, setSerialData] = useState({ classNum: '101', serialNum: '000001', letterCode: 'A' });
            const [status, setStatus] = useState('idle'); 
            const [myCards, setMyCards] = useState(() => {
                const saved = localStorage.getItem('fake_id_cards');
                return saved ? JSON.parse(saved) : [];
            });
            const [statusMsg, setStatusMsg] = useState('');
            const [selectedCard, setSelectedCard] = useState(null); 
            
            // Image Editing State
            const [scale, setScale] = useState(1);
            const [position, setPosition] = useState({ x: 0, y: 0 });
            const [isDragging, setIsDragging] = useState(false);
            const [dragStart, setDragStart] = useState({ x: 0, y: 0 });
            
            const canvasRef = useRef(null);

            useEffect(() => {
                localStorage.setItem('fake_id_cards', JSON.stringify(myCards));
            }, [myCards]);

            // Serial Logic
            useEffect(() => {
                let letter = 'A';
                if(metaData.role.includes('Trainee')) letter = 'A';
                else if(metaData.role.includes('Junior')) letter = 'B';
                else if(metaData.role.includes('Senior')) letter = 'C';
                else if(metaData.role.includes('Ambassador')) letter = 'Z';

                const deptInput = metaData.affiliation.trim();
                let deptCode = '000'; 

                const findDeptInfo = (input) => {
                    const normalize = (str) => str.toLowerCase().replace(/^(dept\.?|department|div\.?|division)\s+(of\s+)?/i, "").replace(/[^a-z0-9]/g, "");
                    const target = normalize(input);
                    if (target === 'fsu') return { code: '850', eng: 'Florida State University' };
                    if (departmentData[input]) return departmentData[input];
                    for (const key in departmentData) {
                        const info = departmentData[key];
                        if (normalize(info.eng) === target) return info;
                    }
                    return null;
                };

                const matchedDept = findDeptInfo(deptInput);
                if (matchedDept) deptCode = matchedDept.code;

                const rand4 = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
                setSerialData({ classNum: deptCode, letterCode: letter, serialNum: rand4 });
            }, [metaData.role, metaData.affiliation]);

            const checkPassword = () => {
                if (password.toLowerCase() === 'wise') {
                    setView('create');
                    setAuthError('');
                } else {
                    setAuthError('Incorrect Password');
                }
            };

            const loadImage = (src) => {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.onerror = (e) => reject(e);
                    img.src = src;
                });
            };

            const getThemeColor = (role) => {
                switch(role) {
                    case 'Trainee': return "#F87171"; 
                    case 'Junior': return "#FACC15"; 
                    case 'Senior': return "#4ADE80"; 
                    case 'Ambassador': return "#60A5FA"; 
                    default: return "#F87171";
                }
            };
            
            const drawRoundRect = (ctx, x, y, w, h, r) => {
                if (ctx.roundRect) { ctx.roundRect(x, y, w, h, r); } 
                else {
                    if (w < 2 * r) r = w / 2;
                    if (h < 2 * r) r = h / 2;
                    ctx.beginPath();
                    ctx.moveTo(x + r, y);
                    ctx.arcTo(x + w, y, x + w, y + h, r);
                    ctx.arcTo(x + w, y + h, x, y + h, r);
                    ctx.arcTo(x, y + h, x, y, r);
                    ctx.arcTo(x, y, x + w, y, r);
                    ctx.closePath();
                }
            };
            
            const drawStripedText = (ctx, text, x, y, fontSize) => {
                ctx.save();
                ctx.font = `500 ${fontSize}px 'Montserrat', monospace`;
                ctx.textAlign = "right";
                
                const patternCanvas = document.createElement('canvas');
                patternCanvas.width = 6; patternCanvas.height = 6;
                const pCtx = patternCanvas.getContext('2d');
                pCtx.strokeStyle = "rgba(255, 255, 255, 0.4)"; 
                pCtx.lineWidth = 1;
                pCtx.beginPath(); pCtx.moveTo(0, 6); pCtx.lineTo(6, 0); pCtx.stroke();
                
                const pattern = ctx.createPattern(patternCanvas, 'repeat');
                ctx.fillStyle = pattern;
                ctx.fillText(text, x, y);
                
                ctx.strokeStyle = "rgba(255, 255, 255, 0.9)";
                ctx.lineWidth = 0.5;
                ctx.strokeText(text, x, y);
                ctx.restore();
            };

            const generateBackSide = async (serialCode, themeColor) => {
                const canvas = document.createElement('canvas');
                const width = 600; const height = 900;
                canvas.width = width; canvas.height = height;
                const ctx = canvas.getContext('2d');

                ctx.fillStyle = themeColor; ctx.fillRect(0, 0, width, height);
                ctx.fillStyle = "#ffffff";
                const margin = 25;
                ctx.beginPath();
                drawRoundRect(ctx, margin, 140, width - (margin*2), height - 140 - margin, 30);
                ctx.fill();

                const startX = 60; let currentY = 220; 
                ctx.textAlign = "left";

                const drawField = (label, value, isAffiliation = false, maxFontSize = 56) => {
                    ctx.fillStyle = themeColor;
                    ctx.font = "bold 18px 'Montserrat', sans-serif";
                    ctx.fillText(label, startX, currentY);
                    
                    ctx.beginPath(); ctx.strokeStyle = themeColor; ctx.lineWidth = 2;
                    ctx.moveTo(startX, currentY + 10); ctx.lineTo(width - 60, currentY + 10); ctx.stroke();

                    const textOffset = label === 'NAME' ? 110 : 60; currentY += textOffset;;
                    ctx.fillStyle = "#333333";
                    
                    let fontSize = maxFontSize;
                    if (label === 'NAME') {
                         if (value.length <= 3) fontSize = 80;
                         else if (value.length <= 5) fontSize = 70;
                         else fontSize = 56;
                    }

                    ctx.font = `bold ${fontSize}px 'Montserrat', sans-serif`;
                    const maxWidth = width - 100;
                    
                    if (isAffiliation) {
                        let words = value.split(' ');
                        let line = ''; let testY = currentY;
                        while (ctx.measureText(value).width > maxWidth && fontSize > 30) {
                             fontSize -= 2;
                             ctx.font = `bold ${fontSize}px 'Montserrat', sans-serif`;
                        }
                        for(let n = 0; n < words.length; n++) {
                          let testLine = line + words[n] + ' ';
                          if (ctx.measureText(testLine).width > maxWidth && n > 0) {
                            ctx.fillText(line, startX, testY);
                            line = words[n] + ' ';
                            testY += fontSize + 10;
                          } else { line = testLine; }
                        }
                        ctx.fillText(line, startX, testY);
                        currentY = testY + 20; 
                    } else {
                          while (ctx.measureText(value).width > maxWidth && fontSize > 20) {
                             fontSize -= 2; 
                             ctx.font = `bold ${fontSize}px 'Montserrat', sans-serif`;
                          }
                        ctx.fillText(value, startX, currentY);
                    }
                    const nextFieldOffset = label === 'NAME' ? 70 : 120;      currentY += nextFieldOffset;
                };

                drawField("NAME", metaData.name || "NO NAME", false, 56);
                drawField("CLASS", metaData.role);
                
                let displayAff = metaData.affiliation || "University";
                const deptInput = metaData.affiliation.trim();
                
                const normalize = (str) => str.toLowerCase().replace(/^(dept\.?|department|div\.?|division)\s+(of\s+)?/i, "").replace(/[^a-z0-9]/g, "");
                const target = normalize(deptInput);
                
                let matchedInfo = departmentData[deptInput]; 
                if (target === 'fsu') matchedInfo = { code: '850', eng: 'Florida State University' };
                if (!matchedInfo) {
                      for (const key in departmentData) {
                        if (normalize(departmentData[key].eng) === target) {
                            matchedInfo = departmentData[key];
                            break;
                        }
                    }
                }
                if (matchedInfo) displayAff = matchedInfo.eng;
                drawField("AFFILIATION", displayAff, true);

                const verificationUrl = `https://lucanomics.github.io/project-fake-khu/?verify=${serialCode}`;
                try {
                    const qrDataUrl = await QRCode.toDataURL(verificationUrl, {
                        width: 140, margin: 0, color: { dark: themeColor, light: '#ffffff' } 
                    });
                    const qrImg = await loadImage(qrDataUrl);
                    ctx.drawImage(qrImg, width - 180, height - 180, 140, 140);
                } catch (e) {}

                ctx.textAlign = "right";
                drawStripedText(ctx, serialCode, width - 40, height - 210, 18);

                return canvas.toDataURL("image/png");
            };

            const generateFrontCard = async () => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                const width = 600; const height = 900;
                canvas.width = width; canvas.height = height;

                const themeColor = getThemeColor(metaData.role);

                ctx.fillStyle = themeColor; 
                ctx.fillRect(0, 0, width, height);
                
                ctx.fillStyle = "white";
                ctx.beginPath();
                drawRoundRect(ctx, 10, 10, width - 20, height - 20, 30);
                ctx.fill();

                const sidebarWidth = 120;
                const viewWidth = width - sidebarWidth - 20;
                
                ctx.save();
                ctx.beginPath();
                drawRoundRect(ctx, 20, 20, viewWidth, height - 40, 25);
                ctx.clip();
                
                ctx.fillStyle = "#000";
                ctx.fillRect(0, 0, width, height);

                if (rawImage) {
                    try {
                        const userImg = await loadImage(rawImage);
                        const baseScale = Math.max(viewWidth / userImg.width, height / userImg.height);
                        const centerX = viewWidth / 2 + 20; 
                        const centerY = height / 2;
                        
                        ctx.translate(centerX + position.x, centerY + position.y);
                        ctx.scale(baseScale * scale, baseScale * scale);
                        ctx.drawImage(userImg, -userImg.width / 2, -userImg.height / 2);
                    } catch(e) {}
                } else {
                    ctx.fillStyle = "#1e293b";
                    ctx.fillRect(0, 0, width, height);
                }
                ctx.restore();

                ctx.fillStyle = themeColor;
                ctx.beginPath();
                drawRoundRect(ctx, width - sidebarWidth, 50, sidebarWidth - 20, height - 100, 40);
                ctx.fill();

                ctx.save();
                ctx.translate(width - (sidebarWidth / 2) - 10, (height / 2) - 200); 
                ctx.rotate(Math.PI / 2); 
                
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                
                const nameText = metaData.name ? metaData.name.toUpperCase() : "NAME";
                const idText = `${serialData.classNum}${serialData.letterCode}#${serialData.serialNum}`;
                
                ctx.fillStyle = "#ffffff";
                
                let sideFontSize = 26; 
                ctx.font = `bold ${sideFontSize}px 'Montserrat', sans-serif`;
                
                const fullText = `${nameText} | ${idText}`;
                const maxSideWidth = height - 250;
                
                while (ctx.measureText(fullText).width > maxSideWidth && sideFontSize > 14) {
                    sideFontSize -= 1;
                    ctx.font = `bold ${sideFontSize}px 'Montserrat', sans-serif`;
                }

                ctx.fillText(fullText, 0, 0);
                ctx.restore();
                
                if (frontLogo) {
                    try {
                        const logo = await loadImage(frontLogo);
                        const maxW = 330; 
                        const maxH = 330;  
                        const aspect = logo.width / logo.height;
                        
                        let dw = maxW; 
                        let dh = maxW / aspect;
                        if (dh > maxH) { dh = maxH; dw = maxH * aspect; }

                        const logoX = width - (sidebarWidth / 2) - (dw / 2);
                        const logoY = height - dh - 90; 
                        
                        ctx.drawImage(logo, logoX, logoY, dw, dh);
                    } catch(e) {
                         ctx.save();
                         ctx.translate(width - (sidebarWidth/2), height - 80);
                         ctx.rotate(Math.PI / 2);
                         ctx.fillStyle = "rgba(255,255,255,0.7)";
                         ctx.font = "bold 16px sans-serif";
                         ctx.textAlign = "center";
                         ctx.fillText("F.A.K.E.", 0, 0);
                         ctx.restore();
                    }
                }
                
                setFrontImage(canvas.toDataURL("image/png"));
            };

            useEffect(() => {
                if (canvasRef.current) {
                    const timer = setTimeout(() => generateFrontCard(), 300);
                    return () => clearTimeout(timer);
                }
            }, [rawImage, metaData, serialData, scale, position, frontLogo]);

            const handleImageChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => setRawImage(reader.result);
                    reader.readAsDataURL(file);
                }
            };
            
            const handleLogoChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => setFrontLogo(reader.result);
                    reader.readAsDataURL(file);
                }
            };

            const handleMouseDown = (e) => {
                if (!rawImage) return;
                setIsDragging(true);
                setDragStart({ x: e.clientX, y: e.clientY });
            };

            const handleMouseMove = (e) => {
                if (!isDragging) return;
                const dx = e.clientX - dragStart.x;
                const dy = e.clientY - dragStart.y;
                setPosition(prev => ({ x: prev.x + dx * 2, y: prev.y + dy * 2 }));
                setDragStart({ x: e.clientX, y: e.clientY });
            };

            const handleMouseUp = () => setIsDragging(false);
            
            const handleTouchStart = (e) => {
                if (!rawImage) return;
                setIsDragging(true);
                setDragStart({ x: e.touches[0].clientX, y: e.touches[0].clientY });
            };
             const handleTouchMove = (e) => {
                if (!isDragging) return;
                e.preventDefault();
                const dx = e.touches[0].clientX - dragStart.x;
                const dy = e.touches[0].clientY - dragStart.y;
                setPosition(prev => ({ x: prev.x + dx * 2, y: prev.y + dy * 2 }));
                setDragStart({ x: e.touches[0].clientX, y: e.touches[0].clientY });
            };

            const resetTransform = () => { setScale(1); setPosition({x: 0, y: 0}); };
            const fitToFrame = () => { setScale(0.8); setPosition({x: 0, y: 0}); };
            const fillFrame = () => { setScale(1.5); setPosition({x: 0, y: 0}); };

            const saveCard = async () => {
                if (!frontImage) {
                    setStatusMsg("Please upload a photo first!");
                    return;
                }
                
                try {
                    setStatusMsg("Generating...");
                    setStatus('processing');
                    await new Promise(r => setTimeout(r, 500));

                    const themeColor = getThemeColor(metaData.role);
                    const serialCode = `${serialData.classNum}${serialData.letterCode}#${serialData.serialNum}`;
                    const backImage = await generateBackSide(serialCode, themeColor);

                    const newCard = {
                        id: Date.now(),
                        image: frontImage,
                        backImage: backImage,
                        name: metaData.name,
                        role: metaData.role,
                        date: new Date().toLocaleDateString()
                    };

                    setMyCards([newCard, ...myCards]);
                    setStatus('success');
                    setStatusMsg("Done!");
                    
                    setTimeout(() => {
                        setStatus('idle');
                        setMetaData({ name: '', role: 'Trainee', affiliation: '' }); 
                        setView('gallery');
                    }, 1000);
                } catch (error) {
                    console.error("Card generation failed:", error);
                    alert("Card generation failed: " + error.message);
                    setStatus('idle');
                    setStatusMsg("Error occurred");
                }
            };

            const deleteCard = (id) => {
                if(confirm("Delete?")) setMyCards(myCards.filter(c => c.id !== id));
            };

            return (
                <div className="min-h-screen pb-32 text-slate-100" onMouseUp={handleMouseUp} onTouchEnd={handleMouseUp}>
                    <canvas ref={canvasRef} id="cardCanvas" style={{display: 'none'}}></canvas>

                    {/* Header */}
                    <header className="glass-panel sticky top-0 z-40 px-6 py-4 flex justify-between items-center mb-6 shadow-lg">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 bg-gradient-to-tr from-blue-500 to-purple-600 rounded-lg flex items-center justify-center shadow-lg">
                                <i className="fas fa-fingerprint text-white text-lg"></i>
                            </div>
                            <span className="font-bold text-lg tracking-tight text-white">F.A.K.E ID</span>
                        </div>
                        {/* 다크모드 토글 버튼 추가 */}
                        <button 
                            onClick={() => document.documentElement.classList.toggle('dark')}
                            className="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center text-yellow-400 hover:bg-slate-700 transition"
                        >
                            <i className="fas fa-moon text-xs"></i>
                        </button>
                    </header>

                    <main className="max-w-md mx-auto px-5">
                        {/* 1. 인증 화면 */}
                        {view === 'auth' && (
                            <div className="flex flex-col items-center justify-center pt-24 animate-fade-in space-y-6">
                                <div className="text-center space-y-2">
                                    <h2 className="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">
                                        Access Required
                                    </h2>
                                    <p className="text-slate-400 text-sm">프로젝트 멤버 전용 공간입니다.</p>
                                </div>
                                <div className="w-full max-w-xs space-y-3">
                                    <input 
                                        type="password" 
                                        placeholder="Enter Password" 
                                        className="w-full px-4 py-4 bg-slate-800/50 border border-slate-700 rounded-2xl text-white text-center text-lg placeholder-slate-500 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all" 
                                        value={password} 
                                        onChange={e => setPassword(e.target.value)} 
                                        onKeyPress={e => e.key === 'Enter' && checkPassword()} 
                                    />
                                    <button 
                                        onClick={checkPassword} 
                                        className="w-full py-4 bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl font-bold text-lg shadow-lg shadow-blue-900/20 active:scale-95 transition-transform"
                                    >
                                        Unlock System
                                    </button>
                                </div>
                                {authError && <p className="text-red-400 text-sm font-medium bg-red-400/10 px-4 py-2 rounded-full animate-bounce">{authError}</p>}
                            </div>
                        )}

                        {/* 2. 메인 화면 (생성 & 갤러리) */}
                        {(view === 'create' || view === 'gallery') && (
                            <div className="animate-fade-in">
                                {/* 탭 메뉴 */}
                                <div className="flex bg-slate-800/50 p-1.5 rounded-2xl mb-8 border border-slate-700/50 backdrop-blur-sm">
                                    <button onClick={() => setView('create')} className={`flex-1 py-3 rounded-xl font-bold text-sm transition-all ${view === 'create' ? 'bg-slate-700 text-white shadow-md' : 'text-slate-400 hover:text-slate-200'}`}>
                                        <i className="fas fa-plus mr-2"></i>Create
                                    </button>
                                    <button onClick={() => setView('gallery')} className={`flex-1 py-3 rounded-xl font-bold text-sm transition-all ${view === 'gallery' ? 'bg-slate-700 text-white shadow-md' : 'text-slate-400 hover:text-slate-200'}`}>
                                        <i className="fas fa-th-large mr-2"></i>Gallery
                                    </button>
                                </div>

                                {/* Create 탭 */}
                                {view === 'create' && (
                                    <div className="space-y-6">
                                        {/* 사진 업로드/편집 영역 */}
                                        <div className="relative aspect-[2/3] bg-slate-800 rounded-3xl overflow-hidden shadow-2xl border border-slate-700 cursor-move group"
                                             onMouseDown={handleMouseDown} onMouseMove={handleMouseMove}
                                             onTouchStart={handleTouchStart} onTouchMove={handleTouchMove}>
                                            
                                            {frontImage ? 
                                                <img src={frontImage} className="w-full h-full object-cover pointer-events-none" alt="Preview" /> : 
                                                <div className="flex flex-col items-center justify-center h-full text-slate-500 space-y-3">
                                                    <div className="w-16 h-16 rounded-full bg-slate-700/50 flex items-center justify-center">
                                                        <i className="fas fa-camera text-2xl"></i>
                                                    </div>
                                                    <span className="font-medium">Upload your photo</span>
                                                </div>
                                            }
                                            {/* 편집 힌트 오버레이 */}
                                            {rawImage && <div className="absolute top-4 left-1/2 -translate-x-1/2 bg-black/50 backdrop-blur px-3 py-1 rounded-full text-xs text-white/80 pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity">Drag to move</div>}
                                        </div>

                                        {/* 컨트롤러 (사진 있을 때만 표시) */}
                                        {rawImage && (
                                            <div className="bg-slate-800/80 p-4 rounded-2xl border border-slate-700/50 backdrop-blur-md">
                                                <div className="flex justify-between text-xs text-slate-400 mb-2 font-medium">
                                                    <span>Zoom</span>
                                                    <span>{Math.round(scale * 100)}%</span>
                                                </div>
                                                <input type="range" min="0.1" max="3" step="0.1" value={scale} onChange={e => setScale(parseFloat(e.target.value))} 
                                                    className="w-full h-2 bg-slate-600 rounded-lg appearance-none cursor-pointer accent-blue-500"/>
                                                <div className="grid grid-cols-3 gap-2 mt-4">
                                                    <button onClick={fitToFrame} className="py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-xs font-medium transition">Fit Frame</button>
                                                    <button onClick={fillFrame} className="py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-xs font-medium transition">Fill Frame</button>
                                                    <button onClick={resetTransform} className="py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-xs font-medium transition">Reset</button>
                                                </div>
                                            </div>
                                        )}

                                        {/* 입력 폼 */}
                                        <div className="space-y-3">
                                            {/* Photo 버튼 하나만 꽉 차게 남김 */}
                                            <label className="btn-upload w-full flex flex-col items-center justify-center py-4 bg-slate-800 rounded-2xl border border-slate-700 cursor-pointer hover:bg-slate-700 transition active:scale-95 mb-3">
                                                <input type="file" accept="image/*" onChange={handleImageChange} className="hidden" />
                                                <div className="flex items-center gap-2">
                                                    <i className="fas fa-camera text-blue-400 text-xl"></i>
                                                    <span className="text-sm font-bold text-slate-200">Upload Photo</span>
                                                </div>
                                            </label>

                                            <div className="bg-slate-800 rounded-2xl p-4 border border-slate-700 space-y-4">
                                                <div className="space-y-1">
                                                    <label className="text-xs text-slate-400 font-bold ml-1">ROLE</label>
                                                    <select value={metaData.role} onChange={e => setMetaData({...metaData, role: e.target.value})} 
                                                        className="w-full p-3 bg-slate-900 rounded-xl text-white font-medium border border-slate-700 focus:border-blue-500 focus:outline-none">
                                                        <option value="Trainee">🔴 Trainee (Red)</option>
                                                        <option value="Junior">🟡 Junior (Yellow)</option>
                                                        <option value="Senior">🟢 Senior (Green)</option>
                                                        <option value="Ambassador">🔵 Ambassador (Blue)</option>
                                                    </select>
                                                </div>
                                                
                                                <div className="space-y-1">
                                                    <label className="text-xs text-slate-400 font-bold ml-1">NAME</label>
                                                    <input type="text" placeholder="ex. KIM FAKE" className="w-full p-3 bg-slate-900 rounded-xl text-white border border-slate-700 focus:border-blue-500 focus:outline-none" 
                                                        value={metaData.name} onChange={e => setMetaData({...metaData, name: e.target.value})} maxLength={15} />
                                                </div>

                                                <div className="space-y-1 relative">
                                                    <label className="text-xs text-slate-400 font-bold ml-1">AFFILIATION</label>
                                                    <input list="dept-list" type="text" placeholder="ex. 경영학과 or Computer Eng" 
                                                        className="w-full p-3 bg-slate-900 rounded-xl text-white border border-slate-700 focus:border-blue-500 focus:outline-none" 
                                                        value={metaData.affiliation} onChange={e => setMetaData({...metaData, affiliation: e.target.value})} maxLength={40} />
                                                    <datalist id="dept-list">
                                                        {Object.keys(departmentData).map(dept => <option key={dept} value={dept} />)}
                                                    </datalist>
                                                </div>
                                            </div>

                                            <button onClick={saveCard} disabled={status === 'processing'}
                                                className={`w-full py-4 rounded-2xl font-bold text-lg shadow-lg flex items-center justify-center gap-2 transition-all 
                                                ${status === 'processing' ? 'bg-slate-700 text-slate-400 cursor-wait' : 'bg-gradient-to-r from-blue-600 to-purple-600 hover:shadow-blue-500/20 active:scale-95'}`}>
                                                {status === 'processing' ? <><i className="fas fa-spinner fa-spin"></i> Generating...</> : <><i className="fas fa-magic"></i> Generate ID Card</>}
                                            </button>
                                            {statusMsg && <p className="text-center text-xs text-blue-400 font-medium animate-pulse">{statusMsg}</p>}
                                        </div>
                                    </div>
                                )}

                                {/* Gallery 탭 */}
                                {view === 'gallery' && (
                                    <div className="grid grid-cols-2 gap-4 pb-24">
                                        {myCards.length === 0 ? (
                                            <div className="col-span-2 flex flex-col items-center justify-center py-20 text-slate-500 space-y-4">
                                                <i className="far fa-id-card text-6xl opacity-20"></i>
                                                <p>발급된 ID 카드가 없습니다.</p>
                                                <button onClick={() => setView('create')} className="text-blue-400 font-bold text-sm hover:underline">첫 카드 만들기</button>
                                            </div>
                                        ) : (
                                            myCards.map(card => (
                                                <FlipCard key={card.id} card={card} onDelete={deleteCard} onClick={() => setSelectedCard(card)} />
                                            ))
                                        )}
                                    </div>
                                )}
                            </div>
                        )}

                        {/* 상세 보기 모달 및 하단 바 */}
                        {selectedCard && (
                            <>
                                <CardModal
                                    card={selectedCard}
                                    onClose={() => setSelectedCard(null)}
                                    onDelete={deleteCard}
                                />
                                
                                {/* 하단 고정 액션 바 (디자인 개선) */}
                                <div className="fixed bottom-0 left-0 right-0 bg-slate-900/80 backdrop-blur-xl border-t border-slate-700/50 pb-safe pt-3 px-6 z-[6000]">
                                    <div className="max-w-md mx-auto flex justify-between items-center">
                                        <button onClick={async () => {
                                            try {
                                                const front = await fetch(selectedCard.image).then(r => r.blob());
                                                const back = await fetch(selectedCard.backImage).then(r => r.blob());
                                                const files = [
                                                    new File([front], "FAKE_ID_Front.png", {type: "image/png"}),
                                                    new File([back], "FAKE_ID_Back.png", {type: "image/png"})
                                                ];
                                                if (navigator.canShare?.({files})) {
                                                    await navigator.share({files, title: "My F.A.K.E ID", text: "경희대 F.A.K.E 프로젝트 인증 ID입니다."});
                                                } else {
                                                    alert("이 브라우저에서는 공유 기능을 지원하지 않습니다. 이미지를 다운로드해서 사용하세요.");
                                                }
                                            } catch (e) { console.log(e); alert("공유를 취소했거나 지원하지 않는 환경입니다."); }
                                        }} className="flex flex-col items-center gap-1 text-slate-400 hover:text-green-400 transition active:scale-95">
                                            <i className="fas fa-share-nodes text-xl"></i>
                                            <span className="text-[10px] font-medium">Share</span>
                                        </button>

                                        <button onClick={async () => {
                                            const { jsPDF } = window.jspdf;
                                            const pdf = new jsPDF({orientation: "p", unit: "mm", format: [54, 86]}); // 신용카드 규격
                                            const frontImg = new Image(); frontImg.src = selectedCard.image;
                                            const backImg = new Image(); backImg.src = selectedCard.backImage;
                                            await Promise.all([ new Promise(r => frontImg.onload = r), new Promise(r => backImg.onload = r) ]);
                                            pdf.addImage(frontImg, "PNG", 0, 0, 54, 86);
                                            pdf.addPage();
                                            pdf.addImage(backImg, "PNG", 0, 0, 54, 86);
                                            pdf.save(`FAKE_ID_${selectedCard.name || "Member"}.pdf`);
                                        }} className="flex flex-col items-center gap-1 text-slate-400 hover:text-red-400 transition active:scale-95">
                                            <i className="fas fa-file-pdf text-xl"></i>
                                            <span className="text-[10px] font-medium">PDF</span>
                                        </button>

                                        <div className="w-px h-8 bg-slate-700"></div>

                                        <button onClick={() => setSelectedCard(null)} className="flex flex-col items-center gap-1 text-slate-400 hover:text-white transition active:scale-95">
                                            <i className="fas fa-times text-xl"></i>
                                            <span className="text-[10px] font-medium">Close</span>
                                        </button>
                                    </div>
                                    <div className="h-6"></div> {/* Safe area spacer */}
                                </div>
                            </>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
