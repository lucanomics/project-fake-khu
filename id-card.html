<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F.A.K.E ID - Smart Actor Platform</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/qrcode@1.5.3/build/qrcode.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { 
            background-color: #0f172a; 
            color: white; 
            font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, sans-serif;
            -webkit-font-smoothing: antialiased;
        }
        
        .glass-panel { 
            background: rgba(30, 41, 59, 0.7); 
            backdrop-filter: blur(12px); 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
        }

        #cardCanvas {
            display: block; 
            margin: 20px auto;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            max-width: 90%; 
            height: auto;
        }

        .card-container { perspective: 1000px; cursor: pointer; }
        .card-inner {
            position: relative; width: 100%; height: 100%;
            text-align: center; transition: transform 0.6s; transform-style: preserve-3d;
        }
        .card-container.flipped .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back {
            position: absolute; width: 100%; height: 100%;
            -webkit-backface-visibility: hidden; backface-visibility: hidden;
            border-radius: 1.5rem; overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }
        .card-back { transform: rotateY(180deg); background-color: #fff; }
        select option { background-color: #1e293b; color: white; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // Icons
        const IconWrapper = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Sparkles = (props) => (<IconWrapper {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z"/></IconWrapper>);
        const Camera = (props) => (<IconWrapper {...props}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></IconWrapper>);
        const Wallet = (props) => (<IconWrapper {...props}><path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4"/><path d="M4 6v12a2 2 0 0 0 2 2h14v-4"/><path d="M18 12a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h4v-8Z"/></IconWrapper>);
        const ImageIcon = (props) => (<IconWrapper {...props}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></IconWrapper>);
        const Download = (props) => (<IconWrapper {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconWrapper>);
        const Trash2 = (props) => (<IconWrapper {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconWrapper>);
        const UserCircle = (props) => (<IconWrapper {...props}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="10" r="3"/><path d="M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662"/></IconWrapper>);
        const Building = (props) => (<IconWrapper {...props}><rect width="16" height="20" x="4" y="2" rx="2" ry="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M8 10h.01"/><path d="M16 10h.01"/><path d="M8 14h.01"/><path d="M16 14h.01"/></IconWrapper>);
        const RefreshCw = (props) => (<IconWrapper {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconWrapper>);

        const FlipCard = ({ card, onDelete }) => {
            const [isFlipped, setIsFlipped] = useState(false);

            const handleDownload = (e, side) => {
                e.stopPropagation(); 
                const link = document.createElement('a');
                link.href = side === 'front' ? card.image : card.backImage;
                link.download = `fake_id_${side}_${card.id}.png`;
                link.click();
            };

            const handleDelete = (e) => {
                e.stopPropagation();
                onDelete(card.id);
            };

            return (
                <div className="space-y-2">
                    <div 
                        className={`card-container aspect-[2/3] w-full ${isFlipped ? 'flipped' : ''}`}
                        onClick={() => setIsFlipped(!isFlipped)}
                    >
                        <div className="card-inner">
                            <div className="card-front">
                                <img src={card.image} className="w-full h-full object-cover" alt="Front" />
                                <div className="absolute top-3 right-3 bg-black/30 p-1.5 rounded-full pointer-events-none backdrop-blur-sm">
                                    <RefreshCw size={16} className="text-white/80" />
                                </div>
                            </div>
                            <div className="card-back flex items-center justify-center bg-white">
                                <img src={card.backImage} className="w-full h-full object-cover" alt="Back" />
                            </div>
                        </div>
                    </div>
                    
                    <div className="flex justify-between items-center bg-slate-800 p-2 rounded-xl text-xs shadow-lg">
                        <div className="flex gap-3 px-2">
                            <button onClick={(e) => handleDownload(e, 'front')} className="text-slate-300 hover:text-white flex items-center gap-1 font-semibold transition-colors">
                                Front <Download size={14}/>
                            </button>
                            <span className="text-slate-600">|</span>
                            <button onClick={(e) => handleDownload(e, 'back')} className="text-slate-300 hover:text-white flex items-center gap-1 font-semibold transition-colors">
                                Back <Download size={14}/>
                            </button>
                        </div>
                        <button onClick={handleDelete} className="p-1.5 bg-red-500/10 text-red-400 rounded-lg hover:bg-red-500 hover:text-white transition-all">
                            <Trash2 size={16}/>
                        </button>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('create'); 
            const [rawImage, setRawImage] = useState(null);     
            const [frontImage, setFrontImage] = useState(null); 
            const [metaData, setMetaData] = useState({ name: '', role: 'Trainee', affiliation: '' });
            const [serialData, setSerialData] = useState({ classNum: '101', serialNum: '000001' });
            const [status, setStatus] = useState('idle'); 
            const [myCards, setMyCards] = useState(() => {
                const saved = localStorage.getItem('fake_id_cards');
                return saved ? JSON.parse(saved) : [];
            });
            const [statusMsg, setStatusMsg] = useState('');
            
            const canvasRef = useRef(null);

            useEffect(() => {
                localStorage.setItem('fake_id_cards', JSON.stringify(myCards));
            }, [myCards]);

            const loadImage = (src) => {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.crossOrigin = "anonymous";
                    img.onload = () => resolve(img);
                    img.onerror = () => reject(new Error(`Failed to load image: ${src}`));
                    img.src = src;
                });
            };

            const generateRandomSerial = () => {
                const randomClass = Math.floor(Math.random() * 250) + 101;
                const randomSerial = Math.floor(Math.random() * 9999) + 1;
                return { classNum: randomClass.toString(), serialNum: randomSerial.toString().padStart(6, '0') };
            };

            // 선택한 등급(Role)에 맞는 파일명을 반환하는 함수
            const getTemplateFilenames = (role) => {
                const key = role.toLowerCase(); // trainee, junior, senior, ambassador
                // Campus Ambassador는 'ambassador'로 처리
                const suffix = key.includes('ambassador') ? 'ambassador' : 
                               key.includes('senior') ? 'senior' :
                               key.includes('junior') ? 'junior' : 'trainee';
                               
                return {
                    front: `./front_${suffix}.png`,
                    back: `./back_${suffix}.png`
                };
            };

            // ----------------------------------------------------
            // 뒷면 생성 (Template #2 스타일 구현)
            // ----------------------------------------------------
            const generateBackSide = async (serialCode) => {
                const canvas = document.createElement('canvas');
                const width = 600;
                const height = 900;
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');

                try {
                    // 1. 등급에 맞는 템플릿 로드
                    const templates = getTemplateFilenames(metaData.role);
                    const backTemplate = await loadImage(templates.back);
                    
                    // 2. 템플릿 그리기 (배경색 포함된 완성형 이미지라고 가정)
                    ctx.drawImage(backTemplate, 0, 0, width, height);

                    // 3. 텍스트 합성
                    const startX = 60;
                    let currentY = 280; // Name 위치 추정

                    // 텍스트 스타일 (흰색)
                    ctx.fillStyle = "#ffffff"; 
                    
                    // NAME Value
                    ctx.font = "bold 60px 'Montserrat', sans-serif";
                    ctx.textAlign = "left";
                    ctx.fillText(metaData.name || "NO NAME", startX, 330);

                    // CLASS Value
                    currentY += 180;
                    ctx.font = "500 64px 'Montserrat', sans-serif"; 
                    ctx.fillText(metaData.role, startX, 510);

                    // AFFILIATION Value
                    currentY += 180;
                    ctx.font = "600 52px 'Montserrat', sans-serif"; 
                    ctx.fillText(metaData.affiliation || "F.A.K.E Univ", startX, 700);

                    // QR 코드 생성
                    const verificationUrl = `https://lucanomics.github.io/project-fake-khu/?verify=${serialCode}`;
                    const qrDataUrl = await QRCode.toDataURL(verificationUrl, {
                        width: 150, margin: 0,
                        color: { dark: '#000000', light: '#ffffff' } 
                    });

                    if (qrDataUrl) {
                        const qrImg = await loadImage(qrDataUrl);
                        // 우측 하단 배치
                        ctx.drawImage(qrImg, width - 190, height - 190, 150, 150);
                    }

                    // 시리얼 번호 (QR 위쪽)
                    ctx.textAlign = "right";
                    ctx.font = "500 24px 'Montserrat', monospace";
                    ctx.fillStyle = "rgba(255,255,255,0.9)";
                    ctx.fillText(serialCode, width - 40, height - 210);

                } catch (e) {
                    console.error("Back template load error", e);
                    // 템플릿 로드 실패 시
                    ctx.fillStyle = "#333";
                    ctx.fillRect(0,0,width,height);
                    ctx.fillStyle = "white";
                    ctx.font = "30px sans-serif";
                    ctx.fillText("Image Load Error", 50, 50);
                }

                return canvas.toDataURL("image/png");
            };

            // ----------------------------------------------------
            // 앞면 생성 (Template #1 스타일 구현)
            // ----------------------------------------------------
            const generateFrontCard = async () => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                const width = 600;
                const height = 900;
                canvas.width = width;
                canvas.height = height;

                try {
                    // 1. 사용자 사진 (맨 밑바닥)
                    if (rawImage) {
                        const userImg = await loadImage(rawImage);
                        
                        ctx.fillStyle = "#000"; 
                        ctx.fillRect(0, 0, width, height);
                        
                        const scale = Math.max(width / userImg.width, height / userImg.height);
                        const x = (width / scale - userImg.width) / 2;
                        const y = (height / scale - userImg.height) / 2;
                        
                        ctx.drawImage(userImg, x * scale, y * scale, userImg.width * scale, userImg.height * scale);
                    }

                    // 2. 등급에 맞는 앞면 템플릿 덮어쓰기 (가운데 투명)
                    const templates = getTemplateFilenames(metaData.role);
                    const frontTemplate = await loadImage(templates.front);
                    ctx.drawImage(frontTemplate, 0, 0, width, height);

                    // 3. 우측 사이드바 텍스트 (세로 쓰기)
                    ctx.save();
                    ctx.translate(width - 65, height / 2); 
                    ctx.rotate(Math.PI / 2); 
                    
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";
                    
                    const nameText = metaData.name ? metaData.name.toUpperCase() : "NAME";
                    const idText = `${serialData.classNum}Z#${serialData.serialNum}`;
                    
                    ctx.fillStyle = "#ffffff";
                    ctx.font = "700 42px 'Montserrat', sans-serif";
                    ctx.fillText(`${nameText}   |   ${idText}`, 0, 0);
                    ctx.restore();

                } catch (e) {
                    console.error("Front template load error", e);
                    ctx.fillStyle = "#333";
                    ctx.fillRect(0,0,width,height);
                    ctx.fillStyle = "white";
                    ctx.fillText("Front Image Error", 50, 50);
                }

                setFrontImage(canvas.toDataURL("image/png"));
            };

            // Trigger updates
            useEffect(() => {
                if (rawImage) {
                    const newSerial = generateRandomSerial();
                    setSerialData(newSerial);
                }
            }, [rawImage]);

            useEffect(() => {
                if (rawImage && canvasRef.current) {
                    generateFrontCard();
                }
            }, [rawImage, metaData, serialData]); 

            const handleImageChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => setRawImage(reader.result);
                    reader.readAsDataURL(file);
                }
            };

            const saveCard = async () => {
                if (!frontImage) {
                    setStatusMsg("사진을 먼저 업로드해주세요!");
                    setTimeout(() => setStatusMsg(""), 3000);
                    return;
                }

                setStatusMsg("ID 카드를 생성하고 있습니다...");
                setStatus('processing');
                
                await new Promise(r => setTimeout(r, 1000));

                const serialCode = `${serialData.classNum}Z#${serialData.serialNum}`;
                const backImage = await generateBackSide(serialCode);

                const newCard = {
                    id: Date.now(),
                    image: frontImage,
                    backImage: backImage,
                    name: metaData.name || "NO NAME",
                    role: metaData.role, 
                    affiliation: metaData.affiliation,
                    serial: serialCode,
                    date: new Date().toLocaleDateString()
                };

                setMyCards([newCard, ...myCards]);
                setStatus('success');
                setStatusMsg("발급 완료!");

                setTimeout(() => {
                    setStatus('idle');
                    setRawImage(null);
                    setFrontImage(null);
                    setMetaData({ name: '', role: 'Trainee', affiliation: '' }); 
                    setStatusMsg("");
                    setView('gallery');
                }, 1500);
            };

            const deleteCard = (id) => {
                if (confirm('정말 이 ID 카드를 삭제하시겠습니까?')) {
                    setMyCards(myCards.filter(card => card.id !== id));
                }
            };

            return (
                <div className="min-h-screen pb-20">
                    <canvas ref={canvasRef} id="cardCanvas"></canvas>

                    <header className="glass-panel sticky top-0 z-50 px-5 py-4 flex justify-between items-center">
                        <div className="flex items-center gap-2">
                            <div className="w-8 h-8 bg-gradient-to-tr from-purple-500 to-pink-500 rounded-lg flex items-center justify-center">
                                <Sparkles className="text-white w-5 h-5" />
                            </div>
                            <span className="font-bold text-lg tracking-tight">F.A.K.E ID</span>
                        </div>
                    </header>

                    <main className="max-w-md mx-auto mt-6 px-4">
                        <div className="flex bg-slate-800 p-1 rounded-2xl mb-8">
                            <button 
                                onClick={() => setView('create')}
                                className={`flex-1 py-3 rounded-xl text-sm font-bold transition-all ${view === 'create' ? 'bg-slate-600 text-white shadow-lg' : 'text-slate-500 hover:text-slate-300'}`}
                            >
                                ID 제작하기
                            </button>
                            <button 
                                onClick={() => setView('gallery')}
                                className={`flex-1 py-3 rounded-xl text-sm font-bold transition-all ${view === 'gallery' ? 'bg-slate-600 text-white shadow-lg' : 'text-slate-500 hover:text-slate-300'}`}
                            >
                                ID 보관함 ({myCards.length})
                            </button>
                        </div>

                        {view === 'create' ? (
                            <div className="animate-fade-in space-y-6">
                                <div className="relative aspect-[2/3] bg-slate-800 rounded-2xl overflow-hidden shadow-2xl border border-slate-700/50">
                                    {frontImage ? (
                                        <img src={frontImage} className="w-full h-full object-cover" alt="Card Preview" />
                                    ) : (
                                        <div className="flex flex-col items-center justify-center h-full text-slate-500">
                                            <div className="w-16 h-16 rounded-full bg-slate-700 flex items-center justify-center mb-4">
                                                <Camera size={32} className="opacity-50" />
                                            </div>
                                            <p className="text-sm font-medium">프로필 사진을 올려주세요</p>
                                        </div>
                                    )}

                                    {status !== 'idle' && (
                                        <div className="absolute inset-0 bg-black/80 flex flex-col items-center justify-center backdrop-blur-sm z-20">
                                            <div className="text-center animate-bounce">
                                                <CheckCircle2 size={56} className="text-green-500 mx-auto mb-4" />
                                                <p className="text-green-400 font-bold text-lg">발급 완료!</p>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                <div className="space-y-4">
                                    <label className="block w-full py-4 bg-slate-800 border-2 border-dashed border-slate-600 hover:border-purple-500 hover:text-purple-400 text-slate-400 font-bold rounded-2xl text-center cursor-pointer transition-all">
                                        <input type="file" accept="image/*" onChange={handleImageChange} className="hidden" />
                                        <div className="flex items-center justify-center gap-2">
                                            <ImageIcon size={20} /> 
                                            {rawImage ? '사진 변경하기' : '사진 업로드'}
                                        </div>
                                    </label>

                                    <div className="bg-slate-800 rounded-2xl p-1 relative">
                                        <div className="absolute left-4 top-1/2 transform -translate-y-1/2 text-slate-400">
                                            <UserCircle size={20} />
                                        </div>
                                        <select 
                                            value={metaData.role}
                                            onChange={(e) => setMetaData({...metaData, role: e.target.value})}
                                            className="w-full pl-12 pr-4 py-3 bg-transparent text-white font-bold focus:outline-none cursor-pointer appearance-none"
                                        >
                                            <option value="Trainee">1. Trainee (Red)</option>
                                            <option value="Junior">2. Junior (Yellow)</option>
                                            <option value="Senior">3. Senior (Green)</option>
                                            <option value="Ambassador">4. Ambassador (Blue)</option>
                                        </select>
                                    </div>

                                    <div className="bg-slate-800 rounded-2xl p-1">
                                        <input 
                                            type="text" 
                                            placeholder="이름 (예: JADEN)" 
                                            className="w-full px-4 py-3 bg-transparent text-white font-bold text-center focus:outline-none placeholder-slate-600 tracking-wider"
                                            value={metaData.name}
                                            onChange={(e) => setMetaData({...metaData, name: e.target.value})}
                                            maxLength={15}
                                        />
                                    </div>

                                    <div className="bg-slate-800 rounded-2xl p-1 relative">
                                        <div className="absolute left-4 top-1/2 transform -translate-y-1/2 text-slate-400">
                                            <Building size={20} />
                                        </div>
                                        <input 
                                            type="text" 
                                            placeholder="소속 (예: Kyung Hee Univ)" 
                                            className="w-full px-12 py-3 bg-transparent text-white font-bold text-center focus:outline-none placeholder-slate-600 tracking-wider"
                                            value={metaData.affiliation}
                                            onChange={(e) => setMetaData({...metaData, affiliation: e.target.value})}
                                            maxLength={25}
                                        />
                                    </div>

                                    <button 
                                        onClick={saveCard}
                                        className={`w-full py-4 rounded-2xl font-bold text-lg shadow-lg transition-all transform active:scale-95 ${
                                            status !== 'idle'
                                            ? 'bg-slate-800 text-slate-500 cursor-not-allowed' 
                                            : (!frontImage ? 'bg-slate-700 text-slate-300 hover:bg-slate-600' : 'bg-gradient-to-r from-purple-600 to-pink-600 text-white hover:shadow-purple-500/40 loading-shimmer')
                                        }`}
                                    >
                                        {status === 'idle' ? 'ID 카드 발급받기' : '처리 중...'}
                                    </button>
                                    
                                    <div className="text-center h-6">
                                        {statusMsg && <p className="text-sm text-pink-400 font-medium animate-pulse">{statusMsg}</p>}
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="animate-fade-in">
                                {myCards.length === 0 ? (
                                    <div className="text-center py-20 bg-slate-800/50 rounded-3xl border border-dashed border-slate-700">
                                        <div className="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4">
                                            <Wallet className="text-slate-600" />
                                        </div>
                                        <p className="text-slate-500">발급된 ID가 없습니다</p>
                                        <button onClick={() => setView('create')} className="mt-4 text-purple-400 font-bold text-sm hover:underline">
                                            첫 F.A.K.E ID 만들기
                                        </button>
                                    </div>
                                ) : (
                                    <div className="grid grid-cols-2 gap-4 pb-10">
                                        {myCards.map((card) => (
                                            <FlipCard key={card.id} card={card} onDelete={deleteCard} />
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
