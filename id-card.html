<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F.A.K.E ID - Smart Actor Platform</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/qrcode@1.5.3/build/qrcode.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        body { 
            background-color: #0f172a; 
            color: white; 
            font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, sans-serif;
            -webkit-font-smoothing: antialiased;
            touch-action: manipulation;
        }
        
        .glass-panel { 
            background: rgba(30, 41, 59, 0.7); 
            backdrop-filter: blur(12px); 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
        }

        #cardCanvas {
            display: block; 
            margin: 20px auto;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            max-width: 90%; 
            height: auto;
        }

        .card-container { perspective: 1000px; cursor: pointer; }
        .card-inner {
            position: relative; width: 100%; height: 100%;
            text-align: center; transition: transform 0.6s; transform-style: preserve-3d;
        }
        .card-container.flipped .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back {
            position: absolute; width: 100%; height: 100%;
            -webkit-backface-visibility: hidden; backface-visibility: hidden;
            border-radius: 1.5rem; overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }
        .card-back { transform: rotateY(180deg); background-color: #fff; }
        select option { background-color: #1e293b; color: white; }

        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: #ffffff; cursor: pointer; margin-top: -6px;
            box-shadow: 0 0 2px rgba(0,0,0,0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #475569; border-radius: 2px;
        }

        /* Modal Animation */
        @keyframes modalFadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-content { animation: modalFadeIn 0.2s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // Icons
        const IconWrapper = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Sparkles = (props) => (<IconWrapper {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z"/></IconWrapper>);
        const Camera = (props) => (<IconWrapper {...props}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></IconWrapper>);
        const Wallet = (props) => (<IconWrapper {...props}><path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4"/><path d="M4 6v12a2 2 0 0 0 2 2h14v-4"/><path d="M18 12a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h4v-8Z"/></IconWrapper>);
        const ImageIcon = (props) => (<IconWrapper {...props}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></IconWrapper>);
        const Download = (props) => (<IconWrapper {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconWrapper>);
        const Trash2 = (props) => (<IconWrapper {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconWrapper>);
        const UserCircle = (props) => (<IconWrapper {...props}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="10" r="3"/><path d="M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662"/></IconWrapper>);
        const Building = (props) => (<IconWrapper {...props}><rect width="16" height="20" x="4" y="2" rx="2" ry="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M8 10h.01"/><path d="M16 10h.01"/><path d="M8 14h.01"/><path d="M16 14h.01"/></IconWrapper>);
        const RefreshCw = (props) => (<IconWrapper {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconWrapper>);
        const Lock = (props) => (<IconWrapper {...props}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconWrapper>);
        const CheckCircle2 = (props) => (<IconWrapper {...props}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></IconWrapper>);
        const Move = (props) => (<IconWrapper {...props}><polyline points="5 9 2 12 5 15"/><polyline points="9 5 12 2 15 5"/><polyline points="15 19 12 22 9 19"/><polyline points="19 9 22 12 19 15"/><line x1="2" x2="22" y1="12" y2="12"/><line x1="12" x2="12" y1="2" y2="22"/></IconWrapper>);
        const ZoomIn = (props) => (<IconWrapper {...props}><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/><line x1="11" x2="11" y1="8" y2="14"/><line x1="8" x2="14" y1="11" y2="11"/></IconWrapper>);
        const UploadCloud = (props) => (<IconWrapper {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></IconWrapper>);
        const Maximize = (props) => (<IconWrapper {...props}><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></IconWrapper>);
        const Minimize = (props) => (<IconWrapper {...props}><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 11h3a2 2 0 0 1 2 2v3"/></IconWrapper>);
        const RotateCcw = (props) => (<IconWrapper {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconWrapper>);
        const X = (props) => (<IconWrapper {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconWrapper>);

        // --- Components ---

        const FlipCard = ({ card, onDelete, onClick }) => {
            const [isFlipped, setIsFlipped] = useState(false);

            const handleDownload = (e, side) => {
                e.stopPropagation(); 
                const link = document.createElement('a');
                link.href = side === 'front' ? card.image : card.backImage;
                link.download = `fake_id_${side}_${card.id}.png`;
                link.click();
            };

            const handleDelete = (e) => {
                e.stopPropagation();
                onDelete(card.id);
            };

            const handleClick = (e) => {
                if (onClick) {
                    onClick(); // Open Modal
                } else {
                    setIsFlipped(!isFlipped); // Just Flip
                }
            };

            return (
                <div className="space-y-2">
                    <div 
                        className={`card-container aspect-[2/3] w-full ${isFlipped ? 'flipped' : ''}`}
                        onClick={handleClick}
                    >
                        <div className="card-inner">
                            <div className="card-front">
                                <img src={card.image} className="w-full h-full object-cover" alt="Front" />
                                <div className="absolute top-3 right-3 bg-black/30 p-1.5 rounded-full pointer-events-none backdrop-blur-sm">
                                    <RefreshCw size={16} className="text-white/80" />
                                </div>
                            </div>
                            <div className="card-back flex items-center justify-center bg-white">
                                <img src={card.backImage} className="w-full h-full object-cover" alt="Back" />
                            </div>
                        </div>
                    </div>
                    
                    <div className="flex justify-between items-center bg-slate-800 p-2 rounded-xl text-xs shadow-lg">
                        <div className="flex gap-3 px-2">
                            <button onClick={(e) => handleDownload(e, 'front')} className="text-slate-300 hover:text-white flex items-center gap-1 font-semibold transition-colors">
                                Front <Download size={14}/>
                            </button>
                            <span className="text-slate-600">|</span>
                            <button onClick={(e) => handleDownload(e, 'back')} className="text-slate-300 hover:text-white flex items-center gap-1 font-semibold transition-colors">
                                Back <Download size={14}/>
                            </button>
                        </div>
                        <button onClick={handleDelete} className="p-1.5 bg-red-500/10 text-red-400 rounded-lg hover:bg-red-500 hover:text-white transition-all">
                            <Trash2 size={16}/>
                        </button>
                    </div>
                </div>
            );
        };

        const CardModal = ({ card, onClose, onDelete }) => {
            const [isFlipped, setIsFlipped] = useState(false);

            useEffect(() => {
                const handleEsc = (e) => { if (e.key === 'Escape') onClose(); };
                window.addEventListener('keydown', handleEsc);
                return () => window.removeEventListener('keydown', handleEsc);
            }, [onClose]);

            if (!card) return null;

            const handleDownload = (e, side) => {
                e.stopPropagation(); 
                const link = document.createElement('a');
                link.href = side === 'front' ? card.image : card.backImage;
                link.download = `fake_id_${side}_${card.id}.png`;
                link.click();
            };

            return (
                <div className="fixed inset-0 z-[5000] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md animate-fade-in" onClick={onClose}>
                    <div className="relative w-full max-w-sm modal-content" onClick={e => e.stopPropagation()}>
                        <button onClick={onClose} className="absolute -top-12 right-0 text-white hover:text-gray-300 transition-colors bg-white/10 p-2 rounded-full">
                            <X size={24} />
                        </button>

                        <div 
                            className={`card-container aspect-[2/3] w-full mb-6 ${isFlipped ? 'flipped' : ''}`}
                            onClick={() => setIsFlipped(!isFlipped)}
                        >
                            <div className="card-inner">
                                <div className="card-front">
                                    <img src={card.image} className="w-full h-full object-cover rounded-2xl shadow-2xl" alt="Front" />
                                </div>
                                <div className="card-back">
                                    <img src={card.backImage} className="w-full h-full object-cover rounded-2xl shadow-2xl" alt="Back" />
                                </div>
                            </div>
                        </div>

                        <div className="flex justify-between items-center bg-slate-800 p-4 rounded-2xl shadow-xl border border-slate-700">
                             <div className="flex gap-4">
                                <button onClick={(e) => handleDownload(e, 'front')} className="flex items-center gap-2 text-white font-bold bg-slate-700 px-4 py-3 rounded-xl hover:bg-slate-600 transition">
                                    Front <Download size={18}/>
                                </button>
                                <button onClick={(e) => handleDownload(e, 'back')} className="flex items-center gap-2 text-white font-bold bg-slate-700 px-4 py-3 rounded-xl hover:bg-slate-600 transition">
                                    Back <Download size={18}/>
                                </button>
                            </div>
                            <button 
                                onClick={() => { 
                                    if(confirm('Delete this card?')) { 
                                        onDelete(card.id); 
                                        onClose(); 
                                    } 
                                }} 
                                className="p-3 bg-red-500/20 text-red-400 rounded-xl hover:bg-red-500 hover:text-white transition"
                            >
                                <Trash2 size={20}/>
                            </button>
                        </div>
                         <p className="text-center text-slate-400 mt-6 text-sm font-medium animate-pulse">Tap card to flip â€¢ Tap background to close</p>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('auth'); 
            const [password, setPassword] = useState('');
            const [authError, setAuthError] = useState('');
            
            const [rawImage, setRawImage] = useState(null);
            const [frontLogo, setFrontLogo] = useState('./fakhu_logo.png'); 
            const [backLogo, setBackLogo] = useState('./fakhu_logo_horizontal.png'); 

            const [frontImage, setFrontImage] = useState(null); 
            const [metaData, setMetaData] = useState({ name: '', role: 'Trainee', affiliation: '' });
            const [serialData, setSerialData] = useState({ classNum: '101', serialNum: '000001' });
            const [status, setStatus] = useState('idle'); 
            const [myCards, setMyCards] = useState(() => {
                const saved = localStorage.getItem('fake_id_cards');
                return saved ? JSON.parse(saved) : [];
            });
            const [statusMsg, setStatusMsg] = useState('');
            const [selectedCard, setSelectedCard] = useState(null); 
            
            // Image Editing State
            const [scale, setScale] = useState(1);
            const [position, setPosition] = useState({ x: 0, y: 0 });
            const [isDragging, setIsDragging] = useState(false);
            const [dragStart, setDragStart] = useState({ x: 0, y: 0 });
            
            const canvasRef = useRef(null);

            useEffect(() => {
                localStorage.setItem('fake_id_cards', JSON.stringify(myCards));
            }, [myCards]);

            const checkPassword = () => {
                if (password.toLowerCase() === 'wise') {
                    setView('create');
                    setAuthError('');
                } else {
                    setAuthError('Incorrect Password');
                }
            };

            const loadImage = (src) => {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.onerror = (e) => reject(e);
                    img.src = src;
                });
            };

            const generateRandomSerial = () => {
                const randomClass = Math.floor(Math.random() * 250) + 101;
                const randomSerial = Math.floor(Math.random() * 9999) + 1;
                return { classNum: randomClass.toString(), serialNum: randomSerial.toString().padStart(6, '0') };
            };

            const getThemeColor = (role) => {
                switch(role) {
                    case 'Trainee': return "#F87171"; // Red
                    case 'Junior': return "#FACC15"; // Yellow
                    case 'Senior': return "#4ADE80"; // Green
                    case 'Ambassador': return "#60A5FA"; // Blue
                    default: return "#F87171";
                }
            };
            
            // Helper for striped text (Hatch Pattern - Enhanced)
            const drawStripedText = (ctx, text, x, y, fontSize) => {
                ctx.save();
                ctx.font = `500 ${fontSize}px 'Montserrat', monospace`;
                ctx.textAlign = "right";

                // 1. Create Pattern Canvas (Higher density)
                const patternCanvas = document.createElement('canvas');
                patternCanvas.width = 8;
                patternCanvas.height = 8;
                const pCtx = patternCanvas.getContext('2d');
                
                // Draw Hatch Lines
                pCtx.strokeStyle = "rgba(255, 255, 255, 0.4)"; // Stripe color
                pCtx.lineWidth = 2;
                pCtx.beginPath();
                pCtx.moveTo(0, 8);
                pCtx.lineTo(8, 0);
                pCtx.stroke();
                
                const pattern = ctx.createPattern(patternCanvas, 'repeat');
                
                // 2. Draw Text with Pattern Fill
                ctx.fillStyle = pattern;
                ctx.fillText(text, x, y);
                
                // 3. Draw Solid Outline for readability
                ctx.strokeStyle = "rgba(255, 255, 255, 0.9)";
                ctx.lineWidth = 1;
                ctx.strokeText(text, x, y);
                
                // 4. Fill slightly with white to make it visible over dark QR background if any
                ctx.fillStyle = "rgba(255, 255, 255, 0.1)";
                ctx.fillText(text, x, y);
                
                ctx.restore();
            };


            // [Back Side] - Updated for Horizontal Logo
            const generateBackSide = async (serialCode, themeColor) => {
                const canvas = document.createElement('canvas');
                const width = 600;
                const height = 900;
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');

                // 1. Background
                ctx.fillStyle = themeColor;
                ctx.fillRect(0, 0, width, height);

                // 2. White Inner Box
                ctx.fillStyle = "#ffffff";
                const margin = 25;
                ctx.beginPath();
                ctx.roundRect(margin, 140, width - (margin*2), height - 140 - margin, 30);
                ctx.fill();

                // 3. Header: F.A.K.E Text
                ctx.fillStyle = "#ffffff";
                ctx.font = "900 36px 'Montserrat', sans-serif";
                ctx.textAlign = "left";
                ctx.fillText("F.A.K.E", 40, 80);

                // 3-1. Back Logo (Horizontal - Bigger)
                if (backLogo) {
                    try {
                        const logo = await loadImage(backLogo);
                        // Increase size for horizontal logo (Big header logo)
                        const logoW = 340; 
                        const logoH = 100; 
                        const aspect = logo.width / logo.height;
                        
                        let drawW = logoW;
                        let drawH = logoW / aspect;
                        if (drawH > logoH) {
                            drawH = logoH;
                            drawW = logoH * aspect;
                        }
                        // Draw next to F.A.K.E text
                        ctx.drawImage(logo, 180, 30, drawW, drawH);
                    } catch(e) { console.warn("Back Logo draw failed"); }
                }

                // 4. Content Text
                const startX = 60;
                let currentY = 220; 
                ctx.textAlign = "left";

                const drawField = (label, value, isAffiliation = false) => {
                    ctx.fillStyle = themeColor;
                    ctx.font = "bold 18px 'Montserrat', sans-serif";
                    ctx.fillText(label, startX, currentY);
                    
                    ctx.beginPath();
                    ctx.strokeStyle = themeColor;
                    ctx.lineWidth = 2;
                    ctx.moveTo(startX, currentY + 10);
                    ctx.lineTo(width - 60, currentY + 10);
                    ctx.stroke();

                    currentY += 60;
                    ctx.fillStyle = "#333333";
                    
                    let fontSize = 56;
                    ctx.font = `bold ${fontSize}px 'Montserrat', sans-serif`;
                    // Limit width to avoid QR area
                    const isNearBottom = currentY > 600;
                    const maxWidth = isNearBottom ? width - 220 : width - 100;
                    
                    if (isAffiliation) {
                        let words = value.split(' ');
                        let line = '';
                        let testY = currentY;
                        
                        while (ctx.measureText(value).width > maxWidth && fontSize > 30) {
                             fontSize -= 2;
                             ctx.font = `bold ${fontSize}px 'Montserrat', sans-serif`;
                        }

                        for(let n = 0; n < words.length; n++) {
                          let testLine = line + words[n] + ' ';
                          if (ctx.measureText(testLine).width > maxWidth && n > 0) {
                            ctx.fillText(line, startX, testY);
                            line = words[n] + ' ';
                            testY += fontSize + 10;
                          } else { line = testLine; }
                        }
                        ctx.fillText(line, startX, testY);
                        currentY = testY + 20; 
                    } else {
                         while (ctx.measureText(value).width > maxWidth && fontSize > 20) {
                             fontSize -= 4;
                             ctx.font = `bold ${fontSize}px 'Montserrat', sans-serif`;
                         }
                        ctx.fillText(value, startX, currentY);
                    }
                    currentY += 120;
                };

                drawField("NAME", metaData.name || "NO NAME");
                drawField("CLASS", metaData.role);
                drawField("AFFILIATION", metaData.affiliation || "University", true);

                // 5. QR Code
                const verificationUrl = `https://lucanomics.github.io/project-fake-khu/?verify=${serialCode}`;
                try {
                    const qrDataUrl = await QRCode.toDataURL(verificationUrl, {
                        width: 140, margin: 0, color: { dark: themeColor, light: '#ffffff' } 
                    });
                    const qrImg = await loadImage(qrDataUrl);
                    ctx.drawImage(qrImg, width - 180, height - 180, 140, 140);
                } catch (e) {}

                // Serial Number (Striped & Moved Up)
                // Render striped text at bottom right, avoiding QR
                drawStripedText(ctx, serialCode, width - 40, height - 210, 28);

                return canvas.toDataURL("image/png");
            };

            // [Front Side] - Updated Layout & Logo
            const generateFrontCard = async () => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                const width = 600;
                const height = 900;
                canvas.width = width;
                canvas.height = height;

                const themeColor = getThemeColor(metaData.role);

                // 1. Background
                ctx.fillStyle = themeColor; 
                ctx.fillRect(0, 0, width, height);
                
                // 2. White Container
                ctx.fillStyle = "white";
                ctx.beginPath();
                ctx.roundRect(10, 10, width - 20, height - 20, 30);
                ctx.fill();

                // 3. User Photo Area
                const sidebarWidth = 120;
                const viewWidth = width - sidebarWidth - 20;
                
                ctx.save();
                ctx.beginPath();
                ctx.roundRect(20, 20, viewWidth, height - 40, 25);
                ctx.clip();
                
                ctx.fillStyle = "#000";
                ctx.fillRect(0, 0, width, height);

                if (rawImage) {
                    try {
                        const userImg = await loadImage(rawImage);
                        const baseScale = Math.max(viewWidth / userImg.width, height / userImg.height);
                        const centerX = viewWidth / 2 + 20; 
                        const centerY = height / 2;
                        
                        ctx.translate(centerX + position.x, centerY + position.y);
                        ctx.scale(baseScale * scale, baseScale * scale);
                        ctx.drawImage(userImg, -userImg.width / 2, -userImg.height / 2);
                    } catch(e) {}
                } else {
                    ctx.fillStyle = "#1e293b";
                    ctx.fillRect(0, 0, width, height);
                }
                ctx.restore();

                // 4. Sidebar Background
                ctx.fillStyle = themeColor;
                ctx.beginPath();
                ctx.roundRect(width - sidebarWidth, 50, sidebarWidth - 20, height - 100, 40);
                ctx.fill();

                // 5. Sidebar Text (Rotated)
                ctx.save();
                // Move text UP significantly to avoid logo at bottom
                ctx.translate(width - (sidebarWidth / 2) - 10, (height / 2) - 80); 
                ctx.rotate(Math.PI / 2); 
                
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                
                const nameText = metaData.name ? metaData.name.toUpperCase() : "NAME";
                const idText = `${serialData.classNum}Z#${serialData.serialNum}`;
                
                ctx.fillStyle = "#ffffff";
                ctx.font = "bold 36px 'Montserrat', sans-serif";
                ctx.fillText(`${nameText}    |    ${idText}`, 0, 0);
                ctx.restore();
                
                // 6. Sidebar Logo (Front) - NOT Rotated
                // Draw normally at bottom right of card (over the sidebar)
                
                if (frontLogo) {
                    try {
                        const logo = await loadImage(frontLogo);
                        // Fixed Size for Sidebar Logo
                        const maxW = 100; // Fits inside sidebar width
                        const maxH = 100;  
                        const aspect = logo.width / logo.height;
                        
                        let dw = maxW; 
                        let dh = maxW / aspect;
                        if (dh > maxH) { dh = maxH; dw = maxH * aspect; }

                        // Coordinates: Bottom Right
                        // X = width - sidebarWidth/2 - dw/2 (Center horizontally in sidebar)
                        // Y = height - dh - 40 (Padding from bottom)
                        
                        const lx = width - (sidebarWidth / 2) - (dw / 2);
                        const ly = height - dh - 40; 
                        
                        ctx.drawImage(logo, lx, ly, dw, dh);
                    } catch(e) {
                         // Fallback
                         ctx.fillStyle = "rgba(255,255,255,0.7)";
                         ctx.font = "bold 16px sans-serif";
                         ctx.textAlign = "center";
                         ctx.fillText("F.A.K.E.", width - 60, height - 60);
                    }
                }
                // No restore needed for image draw as we didn't rotate context for it this time

                setFrontImage(canvas.toDataURL("image/png"));
            };

            // React Effects
            useEffect(() => {
                if (rawImage) {
                    const newSerial = generateRandomSerial();
                    setSerialData(newSerial);
                    setScale(1);
                    setPosition({x: 0, y: 0});
                }
            }, [rawImage]);

            useEffect(() => {
                if (canvasRef.current) {
                    const timer = setTimeout(() => generateFrontCard(), 5);
                    return () => clearTimeout(timer);
                }
            }, [rawImage, metaData, serialData, scale, position, frontLogo]);

            const handleImageChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => setRawImage(reader.result);
                    reader.readAsDataURL(file);
                }
            };
            
            const handleLogoChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => setFrontLogo(reader.result);
                    reader.readAsDataURL(file);
                }
            };

            // Touch/Mouse Logic
            const handleMouseDown = (e) => {
                if (!rawImage) return;
                setIsDragging(true);
                setDragStart({ x: e.clientX, y: e.clientY });
            };

            const handleMouseMove = (e) => {
                if (!isDragging) return;
                const dx = e.clientX - dragStart.x;
                const dy = e.clientY - dragStart.y;
                setPosition(prev => ({ x: prev.x + dx * 2, y: prev.y + dy * 2 }));
                setDragStart({ x: e.clientX, y: e.clientY });
            };

            const handleMouseUp = () => setIsDragging(false);
            
            const handleTouchStart = (e) => {
                if (!rawImage) return;
                setIsDragging(true);
                setDragStart({ x: e.touches[0].clientX, y: e.touches[0].clientY });
            };
             const handleTouchMove = (e) => {
                if (!isDragging) return;
                e.preventDefault();
                const dx = e.touches[0].clientX - dragStart.x;
                const dy = e.touches[0].clientY - dragStart.y;
                setPosition(prev => ({ x: prev.x + dx * 2, y: prev.y + dy * 2 }));
                setDragStart({ x: e.touches[0].clientX, y: e.touches[0].clientY });
            };

            const resetTransform = () => { setScale(1); setPosition({x: 0, y: 0}); };
            const fitToFrame = () => { setScale(0.8); setPosition({x: 0, y: 0}); };
            const fillFrame = () => { setScale(1.5); setPosition({x: 0, y: 0}); };

            const saveCard = async () => {
                if (!frontImage) {
                    setStatusMsg("Please upload a photo first!");
                    return;
                }
                setStatusMsg("Generating...");
                setStatus('processing');
                await new Promise(r => setTimeout(r, 500));

                const themeColor = getThemeColor(metaData.role);
                const serialCode = `${serialData.classNum}Z#${serialData.serialNum}`;
                const backImage = await generateBackSide(serialCode, themeColor);

                const newCard = {
                    id: Date.now(),
                    image: frontImage,
                    backImage: backImage,
                    name: metaData.name,
                    role: metaData.role,
                    date: new Date().toLocaleDateString()
                };

                setMyCards([newCard, ...myCards]);
                setStatus('success');
                setStatusMsg("Done!");
                
                setTimeout(() => {
                    setStatus('idle');
                    setMetaData({ name: '', role: 'Trainee', affiliation: '' }); 
                    setView('gallery');
                }, 1000);
            };

            const deleteCard = (id) => {
                if(confirm("Delete?")) setMyCards(myCards.filter(c => c.id !== id));
            };

            return (
                <div className="min-h-screen pb-20" onMouseUp={handleMouseUp} onTouchEnd={handleMouseUp}>
                    <canvas ref={canvasRef} id="cardCanvas" style={{display: 'none'}}></canvas>

                    <header className="glass-panel sticky top-0 z-50 px-5 py-4 flex justify-between items-center mb-6">
                        <div className="flex items-center gap-2">
                            <Sparkles className="text-white w-5 h-5" />
                            <span className="font-bold text-lg tracking-tight">F.A.K.E ID</span>
                        </div>
                    </header>

                    <main className="max-w-md mx-auto px-4">
                        {view === 'auth' && (
                            <div className="flex flex-col items-center justify-center pt-20 animate-fade-in">
                                <h2 className="text-2xl font-bold mb-2">Access Required</h2>
                                <input type="password" placeholder="Enter Password" className="w-full max-w-xs px-4 py-3 bg-slate-800 rounded-xl text-white text-center mb-4" 
                                    value={password} onChange={e => setPassword(e.target.value)} onKeyPress={e => e.key === 'Enter' && checkPassword()} />
                                <button onClick={checkPassword} className="w-full max-w-xs py-3 bg-purple-600 rounded-xl font-bold">Unlock</button>
                                {authError && <p className="text-red-400 mt-2">{authError}</p>}
                            </div>
                        )}

                        {(view === 'create' || view === 'gallery') && (
                            <>
                                <div className="flex bg-slate-800 p-1 rounded-2xl mb-8">
                                    <button onClick={() => setView('create')} className={`flex-1 py-3 rounded-xl font-bold ${view === 'create' ? 'bg-slate-600' : 'text-slate-500'}`}>Create</button>
                                    <button onClick={() => setView('gallery')} className={`flex-1 py-3 rounded-xl font-bold ${view === 'gallery' ? 'bg-slate-600' : 'text-slate-500'}`}>Gallery</button>
                                </div>

                                {view === 'create' ? (
                                    <div className="space-y-4">
                                        <div className="relative aspect-[2/3] bg-slate-800 rounded-2xl overflow-hidden shadow-2xl border border-slate-700/50 cursor-move"
                                             onMouseDown={handleMouseDown} onMouseMove={handleMouseMove}
                                             onTouchStart={handleTouchStart} onTouchMove={handleTouchMove}>
                                            {frontImage ? <img src={frontImage} className="w-full h-full object-cover pointer-events-none" /> : 
                                            <div className="flex items-center justify-center h-full text-slate-500">Upload Photo</div>}
                                        </div>

                                        {rawImage && (
                                            <div className="bg-slate-800 p-3 rounded-xl">
                                                <div className="flex justify-between text-xs text-slate-400 mb-1"><span>Crop / Expand</span><span>Move: Drag Image</span></div>
                                                <input type="range" min="0.1" max="3" step="0.1" value={scale} onChange={e => setScale(parseFloat(e.target.value))} className="w-full accent-purple-500"/>
                                                <div className="grid grid-cols-3 gap-2 mt-2">
                                                    <button onClick={fitToFrame} className="py-2 bg-slate-700 rounded text-xs">Fit</button>
                                                    <button onClick={fillFrame} className="py-2 bg-slate-700 rounded text-xs">Fill</button>
                                                    <button onClick={resetTransform} className="py-2 bg-slate-700 rounded text-xs">Reset</button>
                                                </div>
                                            </div>
                                        )}

                                        <div className="grid grid-cols-2 gap-3">
                                            <label className="block w-full py-3 bg-slate-800 rounded-xl text-center cursor-pointer hover:bg-slate-700">
                                                <input type="file" accept="image/*" onChange={handleImageChange} className="hidden" />
                                                <span className="text-sm font-bold flex items-center justify-center gap-2"><ImageIcon size={16}/> {rawImage ? 'Change Photo' : 'Upload Photo'}</span>
                                            </label>
                                            <label className="block w-full py-3 bg-slate-800 rounded-xl text-center cursor-pointer hover:bg-slate-700">
                                                <input type="file" accept="image/*" onChange={handleLogoChange} className="hidden" />
                                                <span className="text-sm font-bold flex items-center justify-center gap-2"><UploadCloud size={16}/> {frontLogo !== './fakhu_logo.png' ? 'Change Logo' : 'Upload Logo'}</span>
                                            </label>
                                        </div>

                                        <div className="bg-slate-800 rounded-xl p-2 space-y-2">
                                            <select value={metaData.role} onChange={e => setMetaData({...metaData, role: e.target.value})} className="w-full p-2 bg-transparent text-white font-bold border-b border-slate-700">
                                                <option value="Trainee">Trainee (Red)</option>
                                                <option value="Junior">Junior (Yellow)</option>
                                                <option value="Senior">Senior (Green)</option>
                                                <option value="Ambassador">Ambassador (Blue)</option>
                                            </select>
                                            <input type="text" placeholder="Name" className="w-full p-2 bg-transparent text-white border-b border-slate-700" value={metaData.name} onChange={e => setMetaData({...metaData, name: e.target.value})} maxLength={15} />
                                            <input type="text" placeholder="Affiliation" className="w-full p-2 bg-transparent text-white" value={metaData.affiliation} onChange={e => setMetaData({...metaData, affiliation: e.target.value})} maxLength={25} />
                                        </div>

                                        <button onClick={saveCard} className="w-full py-4 bg-gradient-to-r from-purple-600 to-pink-600 rounded-xl font-bold shadow-lg">
                                            {status === 'idle' ? 'Generate ID Card' : 'Processing...'}
                                        </button>
                                        <p className="text-center text-xs text-slate-500">{statusMsg}</p>
                                    </div>
                                ) : (
                                    <div className="grid grid-cols-2 gap-4 pb-10">
                                        {myCards.length === 0 ? <p className="text-slate-500 col-span-2 text-center py-10">No cards yet.</p> :
                                        myCards.map(card => <FlipCard key={card.id} card={card} onDelete={deleteCard} />)}
                                    </div>
                                )}
                            </>
                        )}
                        
                        {/* Detail Modal */}
                        {selectedCard && (
                            <CardModal 
                                card={selectedCard} 
                                onClose={() => setSelectedCard(null)} 
                                onDelete={deleteCard} 
                            />
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
